<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<title>AI Basket â€” ×”×©×•×•××ª ×¡×œ ×§× ×™×•×ª AI</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      crossorigin="anonymous" />

<!-- ×¡×¤×¨×™×•×ª ×œ×™×¦×™×¨×ª PDF ××ª××•× ×” (×œ×œ× ×’×³×™×‘×¨×™×©) -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" crossorigin="anonymous"></script>

<style>
/* ========== THEME ========== */
:root{
  --ink:#e2e8f0; --muted:#9fb0c8; --brand:#3b82f6; --accent:#22d3ee;
  --bg: radial-gradient(120% 100% at 50% -10%, #0f172a 0%, #020617 60%);
  --card: rgba(255,255,255,0.06); --line: rgba(255,255,255,.12); --shadow: 0 14px 34px rgba(0,0,0,.35);

  /* ××•×¨×š ×”-GPS/×”×—×œ×§×” */
  --action-width: min(86%, 366px);

  /* ××™×§×•× ×× ×›×™ ×©×œ ×”××•×•×˜×¨ (GIF) */
  --avatar-pos-y: 50%;

  /* ×’×•×“×œ ×•×–×•× ×œ-Loader ×”×¢×’×•×œ */
  --loader-size: 168px;
  --loader-zoom: 1.0;
}

/* ×‘×¡×™×¡ */
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
a{color:#9ecbff;text-decoration:none}
.app{max-width:520px;margin:0 auto;min-height:100dvh;display:flex;flex-direction:column;overflow:hidden}

/* ===== Header ===== */
.header{
  position:relative; padding:14px 16px 0;
  display:flex; align-items:center; justify-content:space-between; gap:12px;
}
.brand-name{display:flex; align-items:center; gap:10px}
.brand-mini{display:flex; align-items:center; gap:10px; font-weight:900}
.brand-mini .dot{
  width:14px;height:14px;border-radius:50%;
  background:linear-gradient(135deg,#3b82f6,#22d3ee);
  box-shadow:0 6px 12px rgba(59,130,246,.5)
}
/* ×”×—×¥ ×¦×¨×™×š ×œ×”×™×•×ª ××™××™×Ÿ ×œ×œ×•×’×• */
#backTop{
  order:2;
  margin-inline-start:8px;
  width:36px;height:36px;display:grid;place-items:center;
  border-radius:999px;border:1px solid var(--line);background:var(--card);cursor:pointer
}
#backTop svg{width:18px;height:18px;fill:#cbd5e1}
#backTop:hover{border-color:#3b82f6}

/* Assistant â€” ××¨×•×‘×¢ ×›×•×œ×œ ×”××•×•×˜×¨, ×¢×‘×” ×¤×™ 2 ×•×™×¨×“ ××¢×˜ ×œ××˜×” */
.ai-avatar{
  display:none; align-items:center; gap:12px;
  border:2px solid var(--line); background:var(--card); border-radius:16px;
  padding:12px 14px; box-shadow:var(--shadow); backdrop-filter:blur(14px);
  margin-top:10px;
}
.ai-avatar img{
  width:46px;height:46px;border-radius:12px;
  object-fit:cover; object-position:50% var(--avatar-pos-y);
  background:#0b1220;
}
.ai-avatar .t1{font-weight:800; line-height:1}
.ai-avatar .t2{color:var(--muted); font-size:12px; line-height:1}

/* ===== Screens ===== */
.screen{display:none}
.screen.active{display:block}
.page{padding:0 16px 120px}
.box{
  background:var(--card);border-radius:22px;box-shadow:var(--shadow);
  padding:16px;border:1px solid var(--line);backdrop-filter:blur(14px)
}
.muted{color:var(--muted)}
.input{display:flex;flex-direction:column;gap:8px}
.input input,.input textarea{
  width:100%;padding:14px;border-radius:16px;border:1px solid var(--line);
  outline:none;background:rgba(255,255,255,.04);color:#fff
}
.input input:focus{border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,.25)}
.radius-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.btn-chip{border:1px solid var(--line);border-radius:999px;padding:12px 14px;background:rgba(59,130,246,.08);color:#cfe2ff;font-weight:800;cursor:pointer}
.btn-chip:hover{border-color:#3b82f6}

/* ===== Splash ===== */
.splash{
  min-height:100dvh;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:20px
}

/* ××•×•×˜×¨ ×¢×’×•×œ ×¢× ×”×™×œ×” + ×˜×‘×¢×ª ××”×‘×”×‘×ª */
.avatar-wrap{
  position:relative; width:min(70vw,280px); height:min(70vw,280px);
  display:grid; place-items:center; border-radius:50%; isolation:isolate;
}
.avatar-ring{
  position:absolute; inset:-4px; border-radius:50%;
  background:conic-gradient(from 180deg, #3b82f6, #22d3ee, #3b82f6);
  filter:saturate(120%);
  mask: radial-gradient(closest-side, transparent 74%, black 78%);
  animation:ringBlink 2.4s ease-in-out infinite;
}
@keyframes ringBlink{
  0%,100%{opacity:.55; filter:saturate(110%) blur(.2px)}
  50%{opacity:.95; filter:saturate(130%) blur(.4px)}
}
.pulse, .pulse2{
  position:absolute; inset:-10px; border-radius:50%;
  pointer-events:none; mix-blend-mode:screen;
  background:radial-gradient(circle at 50% 50%, rgba(59,130,246,.35), rgba(34,211,238,.15) 45%, transparent 70%);
  filter:blur(12px);
}
.pulse{animation:pulse 2.2s ease-in-out infinite}
.pulse2{animation:pulse 2.2s ease-in-out infinite .9s}
@keyframes pulse{
  0%{transform:scale(.9); opacity:.5}
  50%{transform:scale(1.05); opacity:.88}
  100%{transform:scale(.9); opacity:.5}
}
.avatar{
  width:100%; height:100%; border-radius:50%; overflow:hidden; position:relative;
  box-shadow:0 10px 30px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.07);
  background:#0b1220;
}
.avatar img{
  width:100%; height:100%; display:block; object-fit:cover;
  object-position: 50% var(--avatar-pos-y);
}

/* ×˜×§×¡×˜×™× + ×‘××“×’'×™× */
.splash h1{margin:16px 0 6px; font-size:22px}
.splash p{margin:0 0 14px; color:#9fb0c8}
.badges{display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin-top:10px}
.badge{padding:10px 12px;border-radius:999px;border:1px solid var(--line);background:var(--card);box-shadow:var(--shadow);font-weight:700}

/* GPS & Swipe */
.gps-big{
  margin-top:12px; width:var(--action-width);
  display:inline-flex; align-items:center; justify-content:center; gap:12px;
  padding:14px 20px; border-radius:18px; cursor:pointer;
  background:linear-gradient(135deg,#2a3867,#1f2a4d); color:#eaf0ff;
  border:1px solid #425397; font-weight:900; box-shadow:0 12px 28px rgba(0,0,0,.45), inset 0 1px 0 #ffffff22;
}
.gps-big svg{width:26px;height:26px}
.swipe-wrap{ margin-top:14px; border-radius:16px; padding:12px; color:#bfe0ff; width:var(--action-width) }
.swipe-track{ position:relative; height:48px; background:rgba(255,255,255,.03); border:1px solid var(--line); border-radius:999px; overflow:hidden }
.swipe-ghost{position:absolute; inset:0; background:linear-gradient(90deg, transparent, rgba(59,130,246,.12), transparent); animation:slide 2.4s linear infinite}
@keyframes slide{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
.swipe-hint{font-size:12px; color:#9fb0c8; margin-top:6px}
.knob{
  position:absolute; top:4px; inset-inline-end:6px; width:40px; height:40px; border-radius:999px; display:grid; place-items:center;
  background:linear-gradient(135deg,#3b82f6,#22d3ee); color:#06151d; font-weight:900; box-shadow:0 10px 24px rgba(59,130,246,.4);
  touch-action:none; user-select:none; cursor:grab;
}
.knob:active{cursor:grabbing}
.knob svg{width:18px;height:18px;fill:#06151d}
.progress{position:absolute; inset:0; background:linear-gradient(90deg, rgba(59,130,246,.25), rgba(34,211,238,.2)); transform-origin:right; transform:scaleX(0)}

/* ===== Results styling ===== */
.row{display:flex;justify-content:space-between;align-items:center;padding:14px;border-radius:16px;background:rgba(255,255,255,.04);border:1px solid var(--line)}
.row+.row{margin-top:10px}.total{font-size:18px;font-weight:900}
.small{font-size:12px} .desc{color:#b6c3d8;font-size:12px}
.pill{display:inline-block;padding:4px 8px;border-radius:999px;background:rgba(59,130,246,.12);color:#bfe0ff;font-size:12px;font-weight:700}
.conf{font-size:12px;color:#22c55e;font-weight:800}
.unit{font-size:12px;color:#93c5fd;font-weight:800}
.map{width:100%;height:260px;border-radius:14px;border:1px solid var(--line);margin-top:10px;overflow:hidden}

/* ×›×¤×ª×•×¨×™ ×”×¤×¢×•×œ×•×ª (Waze + PDF) */
.actions{display:flex; gap:8px; flex-wrap:wrap}
.btn-action{
  display:inline-flex; align-items:center; gap:8px;
  padding:10px 12px; border-radius:12px; border:1px solid var(--line);
  background:rgba(255,255,255,.05); color:#e2e8f0; font-weight:800; cursor:pointer;
  text-decoration:none;
}
.btn-action:hover{ border-color:#3b82f6; background:rgba(59,130,246,.08) }
.btn-action svg{ flex:0 0 auto }

/* ×ª×’ "××—×™×¨ ××•×¢×¨×š" */
.pill-est{
  display:inline-block;padding:4px 8px;border-radius:999px;
  background:rgba(234,179,8,.15); color:#fde68a; font-size:12px; font-weight:800;
  border:1px solid rgba(234,179,8,.35);
}

/* Loader Results (GIF ×¢×’×•×œ) */
#loading{display:none;margin-top:12px;text-align:center}
.loading-circle{
  width: var(--loader-size);
  height: var(--loader-size);
  margin: 12px auto 6px;
  border-radius: 50%;
  overflow: hidden;
  border: 3px solid rgba(255,255,255,.12);
  box-shadow: 0 10px 28px rgba(59,130,246,.25), inset 0 0 0 1px rgba(255,255,255,.06);
  background: radial-gradient(60% 60% at 50% 50%, #0b1220 0%, #08101f 60%, transparent 100%);
}
.loading-circle img{
  width: 100%;
  height: 100%;
  object-fit: cover;
  transform: scale(var(--loader-zoom));
  transform-origin: center;
  display: block;
  image-rendering: -webkit-optimize-contrast;
}
#loading .msg{color:#bcd3ff;margin-top:2px}
</style>
</head>

<body>
<div class="app">
  <!-- Header -->
  <div class="header">
    <div class="brand-name">
      <div class="brand-mini"><div class="dot"></div><span>AI Basket</span></div>
      <!-- ×”×—×¥ ××™××™×Ÿ ×œ×œ×•×’×• -->
      <button id="backTop" title="×—×–×¨×”">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
      </button>
    </div>

    <!-- Assistant (×××¡×š 2 ×•××™×œ×š) -->
    <div class="ai-avatar" id="aiMini">
      <img src="ai_giff4.gif" alt="Assistant">
      <div>
        <div class="t1">Assistant</div>
        <div class="t2">Always-on smart helper</div>
      </div>
    </div>
  </div>

  <!-- Screen 0: Splash -->
  <section id="s0" class="screen active">
    <div class="splash">
      <div class="avatar-wrap">
        <div class="pulse" aria-hidden="true"></div>
        <div class="pulse2" aria-hidden="true"></div>
        <div class="avatar-ring" aria-hidden="true"></div>
        <div class="avatar">
          <img src="ai_giff4.gif" alt="AI waving">
        </div>
      </div>

      <h1 style="margin-top:14px">×”××¢×¨×›×ª ×©×ª××¦× ××ª ×¡×œ ×”×§× ×™×•×ª ×”×–×•×œ ×œ×™×“×š ×‘×××¦×¢×•×ª AI.</h1>
      <div class="badges">
        <span class="badge">âš¡ ×—×•×¡×š ×–××Ÿ</span>
        <span class="badge">ğŸ’¸ ××—×™×¨ ×”×›×™ ×–×•×œ</span>
        <span class="badge">AI ğŸ¤–</span>
      </div>

      <!-- GPS â€“ ××•×ª×• ××•×¨×š ×›××• ×”×”×—×œ×§×” -->
      <button id="gpsBig" class="gps-big" type="button" title="×©×™××•×© ×‘-GPS">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 8.5a3.5 3.5 0 1 0 0 7 3.5 3.5 0 0 0 0-7Zm8.94 2.5a9 9 0 0 0-7.94-7.94V1h-2v2.06A9 9 0 0 0 3.06 11H1v2h2.06A9 9 0 0 0 11 20.94V23h2v-2.06A9 9 0 0 0 20.94 13H23v-2h-2.06ZM12 19a7 7 0 1 1 0-14 7 7 0 0 1 0 14Z" fill="currentColor"/></svg>
        ×©×™××•×© ×‘-GPS
      </button>

      <!-- Swipe to start -->
      <div class="swipe-wrap">
        <div class="swipe-track" id="swipeTrack">
          <div class="progress" id="swipeProgress"></div>
          <div class="swipe-ghost"></div>
          <div class="knob" id="swipeKnob" aria-label="×”×—×œ×§ ×™××™× ×” ×›×“×™ ×œ×”×ª×—×™×œ">
            <svg viewBox="0 0 24 24"><path d="M10 6l-1.41 1.41L13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
          </div>
        </div>
        <div class="swipe-hint">×”×—×œ×§/×™ ××™××™×Ÿ ×œ×©×××œ ×›×“×™ ×œ×”×ª×—×™×œ</div>
      </div>
    </div>
  </section>

  <!-- Screen 2: Address -->
  <section id="s2" class="screen">
    <div class="page">
      <div class="box">
        <div style="font-weight:800;font-size:20px">××” ×”×›×ª×•×‘×ª ×©×œ×š?</div>
        <div class="muted" style="margin-top:6px">××¤×©×¨ ×¢×™×¨/×¨×—×•×‘ ××• GPS ××”×›×¤×ª×•×¨ ×‘×¢××•×“ ×”×¨××©×•×Ÿ</div>
        <div class="input" style="margin-top:12px">
          <label class="muted" for="address">×›×ª×•×‘×ª / ×¢×™×¨</label>
          <input id="address" placeholder="×œ××©×œ: ×—×•×œ×•×Ÿ, ×¡×•×§×•×œ×•×‘ 10" />
        </div>
      </div>
    </div>
  </section>

  <!-- Screen 3: Radius -->
  <section id="s3" class="screen">
    <div class="page">
      <div class="box">
        <div style="font-weight:800;font-size:20px">×¨×“×™×•×¡ ×—×™×¤×•×©</div>
        <div class="muted" style="margin-top:6px">×‘×—×¨/×™ ×›××” ×§×´× ××¡×‘×™×‘ ×œ×›×ª×•×‘×ª/×œ-GPS</div>
        <div class="radius-grid" style="margin-top:12px">
          <button class="btn-chip" type="button" data-radius="2">2 ×§×´×</button>
          <button class="btn-chip" type="button" data-radius="5">5 ×§×´×</button>
          <button class="btn-chip" type="button" data-radius="10">10 ×§×´×</button>
          <button class="btn-chip" type="button" data-radius="15">15 ×§×´×</button>
        </div>
        <div class="input" style="margin-top:12px">
          <label class="muted" for="radius">××• ×”×–×Ÿ/×™ ×™×“× ×™×ª</label>
          <input id="radius" type="number" min="1" step="0.5" placeholder="15" />
        </div>
      </div>
    </div>
  </section>

  <!-- Screen 4: Items + Autocomplete -->
  <section id="s4" class="screen">
    <div class="page">
      <div class="box">
        <div style="font-weight:800;font-size:20px">××” ×ª×¨×¦×” ×œ×§× ×•×ª?</div>
        <div class="muted" style="margin-top:6px">×”×•×¡×£ ××•×¦×¨×™× ×‘×œ×—×™×¦×”. â€œ×§×• 1.5 ×œâ€ â†’ ×§×•×§×” ×§×•×œ×” 1.5 ×œ×³, â€œ×¤×¡×˜×” 500â€ â†’ ×¤×¡×˜×” 500 ×’×¨×â€¦</div>
        <div id="chips" class="chips"></div>
        <div class="add-row">
          <input id="newItem" class="input" placeholder="×œ××©×œ: ×§×• 1.5 ×œ / ×¤×—×™×ª 330 / ×¤×¡×˜×” 500..." autocomplete="off" />
          <button id="addBtn" class="btn-secondary" type="button" title="×”×•×¡×£ ×œ×¨×©×™××”">+ ×”×•×¡×£</button>
          <div id="dropdown" class="dropdown" style="display:none"></div>
        </div>
        <div class="toggle" style="margin-top:12px">
          <input type="checkbox" id="verifiedOnly" checked />
          <label for="verifiedOnly">×”×¦×’ ×¨×§ ×—× ×•×™×•×ª ×××•××ª×•×ª (×•×™×–×•××œ×™)</label>
        </div>
      </div>
    </div>
  </section>

  <!-- Screen 5: Results -->
  <section id="s5" class="screen">
    <div class="page">
      <div class="box">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:800;font-size:20px">×”×ª×•×¦××•×ª</div>
          <span class="pill">AI results</span>
        </div>
        <div id="summary" class="muted" style="margin-top:6px"></div>

        <!-- Loader GIF: ×™×•×¤×™×¢ ×¨×§ ××—×¨×™ ×œ×—×™×¦×” ×¢×œ "×”××©×š" -->
        <div id="loading" aria-live="polite">
          <div class="loading-circle">
            <img id="loadingGif" src="ai_loading.gif" alt="×˜×•×¢×Ÿ ×ª×•×¦××•×ª..." />
          </div>
          <div class="msg">AI ×× ×ª×— ××ª ×¡×œ ×”×§× ×™×•×ª ×©×œ×š...</div>
        </div>

        <div id="results" style="margin-top:12px"></div>
      </div>
    </div>
  </section>
</div>

<!-- CTA -->
<div class="cta" id="cta">
  <div class="inner">
    <button id="next" class="btn btn-primary" type="button">
      <span class="spark" aria-hidden="true"></span>
      ×”××©×š
    </button>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
<script>
/* Bot SVG fallback (×œ× ×—×•×‘×”) */
function getBotSVG(sz=42){
  return '<svg width="'+sz+'" height="'+sz+'" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" style="border-radius:12px;background:#0b1220"><defs><linearGradient id="lg" x1="0" x2="1"><stop offset="0" stop-color="#3b82f6"/><stop offset="1" stop-color="#22d3ee"/></linearGradient></defs><g fill="url(#lg)"><rect x="14" y="18" rx="10" ry="10" width="36" height="26"/><circle cx="24" cy="30" r="3" fill="#fff"/><circle cx="40" cy="30" r="3" fill="#fff"/><rect x="22" y="40" width="20" height="4" rx="2"/></g></svg>';
}

document.addEventListener('DOMContentLoaded', () => {
  // ××¡×›×™×: 0=s0, 1=s2, 2=s3, 3=s4, 4=s5
  const screens = ['s0','s2','s3','s4','s5'].map(id=>document.getElementById(id));
  const cta = document.getElementById('cta');
  const aiMini = document.getElementById('aiMini');
  let step = 0;

  const btnNext = document.getElementById('next');
  const backTop = document.getElementById('backTop');

  const addressEl = document.getElementById('address');
  const radiusEl = document.getElementById('radius');
  const verifiedOnlyEl = document.getElementById('verifiedOnly');

  const chipsEl = document.getElementById('chips');
  const newItemEl = document.getElementById('newItem');
  const dropdown = document.getElementById('dropdown');
  let items = []; // â† ×¨×™×§ ×‘×”×ª×—×œ×”, ×‘×œ×™ ×“×™×¤×•×œ×˜×™×

  const resultsEl = document.getElementById('results');
  const loadingEl = document.getElementById('loading');
  const loadingGif = document.getElementById('loadingGif');
  const summaryEl = document.getElementById('summary');

  // â–¼ ×¨×™×¢× ×•×Ÿ GIF ×× ×œ× ×‘×œ×•×¤
  let loaderLoopTimer = null;
  const GIF_REFRESH_MS = 4000;
  function startGifLoop(){
    stopGifLoop();
    loaderLoopTimer = setInterval(()=>{
      if (loadingEl.style.display === 'none') return;
      const base = (loadingGif.getAttribute('src')||'ai_loading.gif').split('?')[0];
      loadingGif.setAttribute('src', base + '?t=' + Date.now());
    }, GIF_REFRESH_MS);
  }
  function stopGifLoop(){
    if (loaderLoopTimer){ clearInterval(loaderLoopTimer); loaderLoopTimer = null; }
  }

  function showLoading(){ loadingEl.style.display = 'block'; resultsEl.innerHTML = ''; startGifLoop(); }
  function hideLoading(){ loadingEl.style.display = 'none'; stopGifLoop(); }

  function syncCTA(){ cta.classList.toggle('show', step>=1); }
  function syncHeaderAvatar(){ aiMini.style.display = step>=1 ? 'flex' : 'none'; }
  function goto(n){
    step = Math.max(0, Math.min(screens.length-1, n));
    screens.forEach((s,i)=> s.classList.toggle('active', i===step));
    syncCTA(); syncHeaderAvatar();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
  goto(0);

  // Back
  backTop.addEventListener('click', ()=>{ if(step>0) goto(step-1); });

  // SWIPE â†’ ××œ Address (s2)
  const swipeTrack = document.getElementById('swipeTrack');
  const swipeKnob = document.getElementById('swipeKnob');
  const swipeProgress = document.getElementById('swipeProgress');
  initSwipeToStart(swipeTrack, swipeKnob, swipeProgress, ()=> goto(1));

  // GPS ×‘×¡×¤×œ××© â€” ××—×¨×™ ×”×¦×œ×—×” â†¦ ×™×©×™×¨×•×ª ×œ×¨×“×™×•×¡ (s3)
  const gpsBtn = document.getElementById('gpsBig');
  let gps = null;
  gpsBtn?.addEventListener('click', ()=>{
    if (!navigator.geolocation){ alert('×”×“×¤×“×¤×Ÿ ×œ× ×ª×•××š ×‘-GPS'); return; }
    gpsBtn.disabled = true; gpsBtn.textContent = '×××ª×¨ ××™×§×•×...';
    navigator.geolocation.getCurrentPosition(
      (pos)=>{
        gps = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        sessionStorage.setItem('gps', JSON.stringify(gps));
        gpsBtn.textContent = '××™×§×•× ×–×•×”×” âœ…';
        setTimeout(()=>{ gpsBtn.textContent = '×©×™××•×© ×‘-GPS'; gpsBtn.disabled = false; goto(2); }, 500);
      },
      (err)=>{
        gpsBtn.textContent = '×©×™××•×© ×‘-GPS'; gpsBtn.disabled = false;
        alert('×©×’×™××ª GPS: ' + (err.message||err.code));
      },
      { enableHighAccuracy:true, timeout:10000, maximumAge:5000 }
    );
  });

  // ×¨×“×™×•×¡ ××”×™×¨
  document.querySelectorAll('[data-radius]').forEach(b=>{
    b.addEventListener('click', ()=>{
      document.querySelectorAll('[data-radius]').forEach(x=>x.dataset.active="0");
      b.dataset.active="1";
      radiusEl.value = b.getAttribute('data-radius');
      goto(step+1);
    });
  });

  // Chips UI
  function renderChips(){
    chipsEl.innerHTML = "";
    items.forEach((it,i)=>{
      const chip = document.createElement('div');
      chip.className = 'chip';
      chip.innerHTML = `<span>${esc(it)}</span><button class="close" aria-label="×”×¡×¨">Ã—</button>`;
      chip.querySelector('.close').onclick = ()=>{ items.splice(i,1); renderChips(); };
      chipsEl.appendChild(chip);
    });
  }
  renderChips();

  document.getElementById('addBtn').onclick = ()=>{
    const v = (newItemEl.value||'').trim();
    if(!v) return shake(newItemEl);
    items.push(v);
    newItemEl.value = '';
    hideDropdown();
    renderChips();
  };

  // Autocomplete
  let activeIdx = -1;
  newItemEl.addEventListener('input', async ()=>{
    const q = newItemEl.value.trim();
    if (!q) return hideDropdown();
    try{
      const res = await fetch(`/api/suggest?q=${encodeURIComponent(q)}&limit=12`);
      const data = await res.json();
      const list = Array.isArray(data.suggestions) ? data.suggestions : [];
      if (!list.length) return hideDropdown();
      dropdown.innerHTML = list.map((s,i)=>(
        `<div class="opt" data-i="${i}">
          <div class="left">
            <div class="label">${esc(s.label)}</div>
            <div class="meta">${esc(s.canonical)} ${s.default_size? 'â€¢ '+esc(s.default_size):''}${(s.tags||[]).includes('LocalDB')?' â€¢ ×××’×¨ ××§×•××™':''}</div>
          </div>
          <div>${s.brand? esc(s.brand):''}</div>
        </div>`
      )).join('');
      dropdown.style.display = 'block';
      activeIdx = -1;

      dropdown.querySelectorAll('.opt').forEach(opt=>{
        opt.addEventListener('click', ()=>{
          const i = Number(opt.getAttribute('data-i'));
          const picked = list[i];
          if (!picked) return;
          items.push(picked.label);
          newItemEl.value = '';
          hideDropdown();
          renderChips();
        });
      });
    }catch{ hideDropdown(); }
  });
  newItemEl.addEventListener('keydown', (e)=>{
    if (dropdown.style.display !== 'block') return;
    const opts = Array.from(dropdown.querySelectorAll('.opt'));
    if (e.key === 'ArrowDown'){ e.preventDefault(); activeIdx = Math.min(opts.length-1, activeIdx+1); setActive(opts); }
    else if (e.key === 'ArrowUp'){ e.preventDefault(); activeIdx = Math.max(0, activeIdx-1); setActive(opts); }
    else if (e.key === 'Enter'){ if (activeIdx >= 0){ e.preventDefault(); opts[activeIdx].click(); } }
    else if (e.key === 'Escape'){ hideDropdown(); }
  });
  function setActive(opts){ opts.forEach((el,i)=> el.classList.toggle('active', i===activeIdx)); }
  function hideDropdown(){ dropdown.style.display='none'; dropdown.innerHTML=''; activeIdx=-1; }

  // ×›×©×™×© ×ª×•×¦××•×ª â€” ×”×¡×ª×¨ CTA
  const resultsObserver = new MutationObserver(() => {
    const hasResults = resultsEl.children.length > 0 || resultsEl.textContent.trim().length > 0;
    if (hasResults) cta.classList.remove('show');
  });
  resultsObserver.observe(resultsEl, { childList:true, subtree:true, characterData:true });

  // CTA â€œ×”××©×šâ€ â€” ×œ×•×’×™×§×ª ××¢×‘×¨ + ×˜×¢×™× ×ª ×ª×•×¦××•×ª
  btnNext.addEventListener('click', ()=>{
    if(step===1){ if(!addressEl.value.trim() && !sessionStorage.getItem('gps')) return shake(addressEl); goto(2); return; }
    if(step===2){ if(!radiusEl.value) return shake(radiusEl); goto(3); return; }
    if(step===3){
      if(items.length===0) return shake(newItemEl);
      goto(4);        // Results
      showLoading();  // ×”-GIF ××•×¤×™×¢ ×¨×§ ×¢×›×©×™×•
      fetchPlan();    // ×§×¨×™××” ×œ×¦×“ ×©×¨×ª
      return;
    }
    if(step<screens.length-1) return goto(step+1);
  });

  /* ====== ×§×¨×™××” ×œ×©×¨×ª ×•×”×¦×’×ª ×ª×•×¦××•×ª ====== */
  async function fetchPlan(){
    let gps = null;
    try{ gps = JSON.parse(sessionStorage.getItem('gps')||'null'); }catch{}

    const payload = gps
      ? { lat: gps.lat, lng: gps.lng, radiusKm: Number(radiusEl.value || 15), items, include_debug:false }
      : { address: (addressEl.value||'').trim(), radiusKm: Number(radiusEl.value || 15), items, include_debug:false };

    summaryEl.textContent = `${gps ? 'GPS' : '×›×ª×•×‘×ª: ' + (payload.address||'â€”')} â€¢ ×¨×“×™×•×¡: ${payload.radiusKm || ''} ×§×´× â€¢ ×¤×¨×™×˜×™×: ${items.length}`;

    try{
      const res = await fetch('/api/plan', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      const ct = res.headers.get('content-type') || '';
      const raw = await res.text();
      let data = null;
      if (ct.includes('application/json')) { try { data = JSON.parse(raw); } catch {} }

      hideLoading();
      if(!res.ok || !data || data.ok === false){
        resultsEl.innerHTML = row('×©×’×™××ª ×©×¨×ª', (data && data.error) ? data.error : ('×§×•×“: '+res.status+' â€¢ '+raw.slice(0,220)));
        return;
      }
      const baskets = Array.isArray(data.baskets) ? data.baskets : [];
      if(baskets.length===0){ resultsEl.innerHTML = row('×œ× × ××¦××• ×ª×•×¦××•×ª', '× ×¡×• ×œ×”×¨×—×™×‘ ××ª ×”×¨×“×™×•×¡ ××• ×œ×“×™×™×§ ×¤×¨×™×˜×™×'); return; }

      // ×©××•×¨ ×’×¨×¡×” ××¦×•××¦××ª ×©×œ 4 ×”×–×•×œ×™× ×‘×™×•×ª×¨ (×”×©×¨×ª ×›×‘×¨ ××¡×“×¨; ×–×” ×’×™×‘×•×™ ×œ×§×œ×™×™× ×˜)
      const top = baskets.slice(0,4);

      resultsEl.innerHTML = top.map((b,i)=>renderStore(b,i)).join('');
      wireStoreMaps(top);
      // ×—×™×•×•×˜ ×›×¤×ª×•×¨×™ Waze/PDF (×”××–× ×ªÖ¾×¢×œ)
      wireActions();
      cta.classList.remove('show');
    }catch(err){
      await new Promise(r=>setTimeout(r, 800));
      hideLoading();
      resultsEl.innerHTML = row('××¦×‘ ×“××•', '×”×©×¨×ª ×œ× ×–××™×Ÿ ×›×¨×’×¢');
      cta.classList.remove('show');
    }
  }

  // SVG ×œ×•×’×• Waze (inline)
  function wazeSVG(){
    return `
    <svg width="18" height="18" viewBox="0 0 48 48" aria-hidden="true">
      <path fill="#00AEEF" d="M24 6c9.39 0 17 6.72 17 15 0 6.03-3.94 10.94-9.79 13.1-.64 2.3-2.73 3.9-5.21 3.9-2.31 0-4.29-1.36-5.04-3.26-1.35.16-2.74.26-4.16.26-5.38 0-9.52-1.2-11.8-3.47C2.21 29.62 2 27.52 2 26.5c0-1.2.98-2.17 2.18-2.17 1.1 0 2.03.83 2.15 1.9.23 2.06 1.51 3.73 3.3 4.9C9.23 29.96 9 28.72 9 27.5 9 16.52 15.95 6 24 6Z"/>
      <circle cx="30" cy="22" r="3" fill="#000"/>
      <circle cx="19" cy="22" r="3" fill="#000"/>
      <path fill="#000" d="M28.5 33.5a1.5 1.5 0 0 1 3 0v1a1.5 1.5 0 0 1-3 0v-1Zm-6 0a1.5 1.5 0 0 1 3 0v1a1.5 1.5 0 0 1-3 0v-1Z"/>
    </svg>`;
  }

  // ×¨× ×“×¨ ×©×œ ×—× ×•×ª + ××¤×” + ×›×¤×ª×•×¨×™ ×¤×¢×•×œ×”
  function renderStore(b, idx){
    const total = toPrice(b.total, 'â‚ª');
    const addr = b.location?.address || '';
    const mo = (typeof b.match_overall === 'number') ? `${Math.round(b.match_overall*100)}%` : 'â€”';
    const cov = (typeof b.coverage === 'number') ? `${Math.round(b.coverage*100)}%` : 'â€”';
    const dist = (typeof b.distance_km === 'number') ? ` â€¢ ××¨×—×§ ${b.distance_km} ×§×´×` : '';

    const actionsBar = `
      <div class="actions" style="margin-top:8px">
        <a class="btn-action" data-waze="${idx}" href="#">
          ${wazeSVG()}<span>× ×•×•×˜ ×‘-Waze</span>
        </a>
        <button class="btn-action" data-pdf="${idx}" type="button">ğŸ“„ <span>×”×•×¨×“ ×¨×©×™××ª ×§× ×™×•×ª</span></button>
      </div>`;

    const hdr = `
      <div class="row">
        <div>
          <div><strong>${esc(b.shop_display_name||b.chain||'')}</strong></div>
          <div class="muted small">${esc(addr)} â€¢ ×“×™×•×§ ×›×œ×œ×™ ${mo} â€¢ ×›×™×¡×•×™ ${cov}${dist}</div>
        </div>
        <div class="total">${total}</div>
      </div>
      ${actionsBar}
    `;
    return hdr + `
      <details class="box" style="margin-top:10px" data-idx="${idx}">
        <summary>×¤×™×¨×•×˜ ×¡×œ + ××¤×”</summary>
        <div style="height:8px"></div>
        <div class="map" id="map-${idx}" data-lat="${b.location?.lat??''}" data-lng="${b.location?.lng??''}"></div>
        <div style="height:8px"></div>
        ${Array.isArray(b.breakdown) ? b.breakdown.map(renderLine).join('') : ''}
        <div style="height:8px"></div>
        ${actionsBar}
      </details>`;
  }

  // ×©×•×¨×” ×‘×ª×•×š ×”×¤×™×¨×•×˜
  function renderLine(p){
    const price = (p.price==null || Number.isNaN(p.price)) ? 'â€”' : toPrice(p.price,'â‚ª');
    const isEstimated = !!p.estimated || (typeof p.confidence_pct === 'number' && p.confidence_pct <= 50) || /××•×¢×¨×š|estimated/i.test(p.description||'');
    const estBadge = isEstimated ? ` <span class="pill-est">××—×™×¨ ××•×¢×¨×š</span>` : '';
    const desc = p.description ? `<div class="desc">â€” ${esc(p.description)}</div>` : '';
    const sub = p.substitute ? ` <span class="pill">×ª×—×œ×™×£</span>` : '';
    const brand = p.product_brand || p.schema_brand;
    const brandBadge = brand ? ` <span class="pill">${esc(brand)}</span>` : '';
    const unit = (typeof p.unit_per_liter === 'number') ? `<span class="unit">â‚ª/×œ×³ ${p.unit_per_liter.toFixed(2)}</span>` :
                 (typeof p.unit_per_kg === 'number') ? `<span class="unit">â‚ª/×§×´×’ ${p.unit_per_kg.toFixed(2)}</span>` : '';
    const conf = typeof p.confidence_pct === 'number' ? `<span class="conf">${p.confidence_pct}% ×××™× ×•×ª</span>` : '';
    const title = p.product_name || p.chosen_title || p.title || p.item || '';
    const size = p.size_text ? ` <span class="pill">${esc(p.size_text)}</span>` : '';

    return `
      <div class="row">
        <div>
          <div><strong>${esc(p.item||'')}</strong>${sub}${brandBadge}${size}${estBadge}</div>
          <div class="muted small">${esc(title)}</div>
          ${desc}
          <div class="small">${unit} ${conf}</div>
        </div>
        <div class="total">${price}</div>
      </div>
    `;
  }

  // ×—×™×•×•×˜ ××¤×•×ª ×‘×¢×ª ×¤×ª×™×—×ª details
  function wireStoreMaps(baskets){
    document.querySelectorAll('details[data-idx]').forEach((det)=>{
      det.addEventListener('toggle', ()=>{
        if (!det.open) return;
        const idx = det.getAttribute('data-idx');
        const mapDiv = document.getElementById('map-'+idx);
        if (!mapDiv || mapDiv.dataset.inited==="1") return;

        const lat = Number(mapDiv.getAttribute('data-lat'));
        const lng = Number(mapDiv.getAttribute('data-lng'));
        if (!lat || !lng) return;

        const m = L.map(mapDiv).setView([lat,lng], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(m);
        L.marker([lat,lng]).addTo(m);
        mapDiv.dataset.inited = "1";
        setTimeout(()=>m.invalidateSize(), 50);
      });
    });
  }

  // ×”××–× ×ªÖ¾×¢×œ ×œ×›×¤×ª×•×¨×™ Waze + PDF (×’× ×œ××¢×œ×” ×•×’× ×‘×ª×•×š details)
  function wireActions(){
    resultsEl.addEventListener('click', async (e)=>{
      const a = e.target.closest('[data-waze]');
      if (a){
        e.preventDefault();
        const idx = a.getAttribute('data-waze');
        const mapDiv = document.getElementById('map-'+idx);
        // ×× ×”××¤×” ×œ× × ×¤×ª×—×”, × ×©×ª××© ×‘× ×ª×•× ×™× ××”-HTML
        const lat = Number(mapDiv?.getAttribute('data-lat')||0);
        const lng = Number(mapDiv?.getAttribute('data-lng')||0);
        // ×—×¤×© ×›×•×ª×¨×ª ×”×—× ×•×ª
        const container = a.closest('.box') || resultsEl;
        const titleEl = container.querySelector('.row strong');
        const name = titleEl ? titleEl.textContent.trim() : '×”×¡×•×¤×¨';
        openWaze(lat,lng,name);
        return;
      }
      const p = e.target.closest('[data-pdf]');
      if (p){
        e.preventDefault();
        const idx = p.getAttribute('data-pdf');
        const details = resultsEl.querySelector(`details[data-idx="${idx}"]`);
        const headerRow = details?.previousElementSibling; // ×”-ROW ×©×œ ×”×—× ×•×ª
        const storeName = headerRow?.querySelector('strong')?.textContent?.trim() || '×”×—× ×•×ª';
        const addr = headerRow?.querySelector('.muted.small')?.textContent?.trim() || '';
        const lines = Array.from(details?.querySelectorAll('.row')||[])
          .map(el=>{
            const item = el.querySelector('strong')?.textContent?.trim() || '';
            const price = el.querySelector('.total')?.textContent?.trim() || '';
            return { item, price };
          });
        await downloadStorePdf(storeName, addr, lines);
        return;
      }
    }, { passive:true });
  }

  function openWaze(lat, lng, name){
    if (!lat || !lng){
      alert('×—×¡×¨ ××™×§×•× ×œ×—× ×•×ª ×”×–×•.');
      return;
    }
    const url = `https://waze.com/ul?ll=${lat.toFixed(6)},${lng.toFixed(6)}&navigate=yes&zoom=17&q=${encodeURIComponent(name||'')}`;
    window.open(url, '_blank', 'noopener');
  }

  // ×”×¤×§×ª PDF ×œ×œ× ×’×³×™×‘×¨×™×© ×‘×××¦×¢×•×ª html2canvas + jsPDF
  async function downloadStorePdf(storeName, addr, lines){
    // ×‘× ×” DOM × ×¡×ª×¨ ×™×¤×”
    const wrap = document.createElement('div');
    wrap.style.position = 'fixed';
    wrap.style.left = '-99999px';
    wrap.style.top = '0';
    wrap.style.width = '800px';
    wrap.style.padding = '24px';
    wrap.style.background = '#ffffff';
    wrap.style.color = '#0b1220';
    wrap.style.fontFamily = 'Arial, Helvetica, sans-serif';
    wrap.dir = 'rtl';

    wrap.innerHTML = `
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
        <div>${getBotSVG(36)}</div>
        <div style="font-size:22px;font-weight:900">AI BASKET</div>
      </div>
      <div style="font-size:16px;margin-bottom:2px"><b>×—× ×•×ª:</b> ${esc(storeName)}</div>
      <div style="font-size:13px;color:#333;margin-bottom:12px">${esc(addr)}</div>
      <ol style="margin:0;padding-inline-start:22px;font-size:15px;line-height:1.6">
        ${lines.map(l=>`<li><span>${esc(l.item)}</span> â€” <b>${esc(l.price)}</b></li>`).join('')}
      </ol>
    `;
    document.body.appendChild(wrap);

    // ×¦×™×œ×•× ×œ-canvas
    const canvas = await html2canvas(wrap, { scale: 2, backgroundColor: '#ffffff' });
    const imgData = canvas.toDataURL('image/jpeg', 0.95);

    // ×”×›× ×¡ ×œ-PDF
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p','mm','a4');
    const pageW = pdf.internal.pageSize.getWidth();
    const pageH = pdf.internal.pageSize.getHeight();

    // ×”×ª×××ª ×ª××•× ×” ×œ×’×•×“×œ ×“×£
    const imgW = pageW;
    const imgH = (canvas.height / canvas.width) * imgW;
    let y = 0;
    if (imgH <= pageH){
      pdf.addImage(imgData, 'JPEG', 0, y, imgW, imgH);
    } else {
      // ×¤×¨×™×¡×” ×¢×œ ×›××” ×“×¤×™×
      let remaining = imgH;
      let sY = 0;
      const pxPerMm = canvas.width / imgW;
      const pagePxH = pageH * pxPerMm;
      while (remaining > 0){
        const pageCanvas = document.createElement('canvas');
        pageCanvas.width = canvas.width;
        pageCanvas.height = Math.min(pagePxH, remaining);
        const ctx = pageCanvas.getContext('2d');
        ctx.drawImage(canvas, 0, sY, canvas.width, pageCanvas.height, 0, 0, pageCanvas.width, pageCanvas.height);
        const pageImg = pageCanvas.toDataURL('image/jpeg', 0.95);
        pdf.addImage(pageImg, 'JPEG', 0, 0, imgW, (pageCanvas.height / pxPerMm));
        remaining -= pagePxH;
        sY += pagePxH;
        if (remaining > 0) pdf.addPage();
      }
    }

    const fname = `shopping_list_${storeName.replace(/\s+/g,'_')}.pdf`;
    pdf.save(fname);

    // × ×™×§×•×™
    document.body.removeChild(wrap);
  }

  function row(title, msg){ return `<div class="row"><div><strong>${esc(title)}</strong><div class="muted small">${esc(msg)}</div></div></div>`; }

  // Utils
  function shake(el){ el.style.borderColor='#3b82f6'; el.animate([{transform:'translateX(0)'},{transform:'translateX(-4px)'},{transform:'translateX(4px)'},{transform:'translateX(0)'}],{duration:260}); setTimeout(()=>el.style.borderColor='var(--line)',320); }
  function esc(s){return String(s??'').replace(/[&<>"'`=\/]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;"}[c]))}
  function escAttr(s){return String(s??'').replace(/"/g,'&quot;')}
  function toPrice(v, currency){
    if (typeof v === "number") return v.toFixed(2)+" "+currency;
    if (typeof v === "string" && v.trim()) return v.includes("â‚ª") ? v : (v+" "+currency);
    return "â€”";
  }

  // Debug: ?showloader=1 â€” ×œ×¨××•×ª ××ª ×”×¢×™×’×•×œ ××™×™×“
  const url = new URL(location.href);
  if (url.searchParams.get('showloader') === '1'){
    screens.forEach(s=>s.classList.remove('active'));
    document.getElementById('s5').classList.add('active');
    aiMini.style.display = 'flex';
    cta.classList.add('show'); // ××•×¤×¦×™×•× ×œ×™
    showLoading();
  }
});

/* Swipe to start: ×’×¨×™×¨×” RTL */
function initSwipeToStart(track, knob, progressEl, onComplete){
  if(!track || !knob) return;
  const rtl = true; // RTL UI
  let startX=0, curX=0, dragging=false;
  const trackRect = ()=> track.getBoundingClientRect();
  const knobRect  = ()=> knob.getBoundingClientRect();

  function setProgress(p){
    p = Math.max(0, Math.min(1, p));
    progressEl.style.transform = 'scaleX('+(rtl ? (1-p) : p)+')';
    knob.style.insetInlineEnd = (6 + (1-p) * (trackRect().width - knobRect().width - 12))+'px';
  }
  setProgress(0); // initial

  function onStart(e){
    dragging=true;
    startX = (e.touches? e.touches[0].clientX : e.clientX);
    curX = startX;
    e.preventDefault();
  }
  function onMove(e){
    if(!dragging) return;
    curX = (e.touches? e.touches[0].clientX : e.clientX);
    const dx = startX - curX; // swipe right->left gives positive dx
    const maxDx = Math.max(120, trackRect().width - knobRect().width - 12);
    const p = Math.max(0, Math.min(1, dx / maxDx));
    setProgress(p);
  }
  function onEnd(){
    if(!dragging) return;
    dragging=false;
    // Complete if progress >= 0.85
    const endRight = parseFloat(getComputedStyle(knob).insetInlineEnd);
    const p = 1 - (endRight - 6) / (trackRect().width - knobRect().width - 12);
    if(p >= 0.85){
      track.style.pointerEvents='none';
      knob.style.transition='transform .25s ease';
      knob.style.transform='scale(.9)';
      setTimeout(onComplete, 120);
    }else{
      knob.style.transition='inset-inline-end .25s ease';
      setProgress(0);
      setTimeout(()=> knob.style.transition='', 260);
    }
  }
  knob.addEventListener('mousedown', onStart);
  knob.addEventListener('touchstart', onStart, {passive:false});
  window.addEventListener('mousemove', onMove, {passive:false});
  window.addEventListener('touchmove', onMove, {passive:false});
  window.addEventListener('mouseup', onEnd);
  window.addEventListener('touchend', onEnd);
}
</script>
</body>
</html>
