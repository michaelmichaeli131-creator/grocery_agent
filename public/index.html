<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<title>השוואת סל קניות AI</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
:root{ --ink:#0d1321; --muted:#6b7280; --brand:#2fb6ff; --bg:#f5f9ff; --card:#fff; --glass:#ffffffcc; --shadow:0 14px 34px rgba(15,50,90,.12) }
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
.app{max-width:480px;margin:0 auto;min-height:100dvh;display:flex;flex-direction:column;overflow:hidden}
.landing{position:relative;min-height:100dvh;padding:24px 16px 120px;display:flex;flex-direction:column;justify-content:space-between;background:radial-gradient(120% 100% at 50% 0%, #eaf6ff 0%, #f7fbff 60%, transparent 100%)}
.landing-head{display:flex;align-items:center;justify-content:space-between}
.brand-mini{display:flex;align-items:center;gap:10px;font-weight:900}
.brand-mini .dot{width:14px;height:14px;border-radius:50%;background:linear-gradient(135deg,#76d2ff,#2fb6ff);box-shadow:0 6px 12px #2fb6ff55}
.how{color:#075985;text-decoration:underline;font-weight:700}
.landing-center{text-align:center;margin-top:8vh}
.hero-title{font-size:clamp(22px,5.2vw,32px);line-height:1.15;margin:0}
.hero-sub{color:var(--muted);margin:.5rem 0 1.1rem}
.badges{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-bottom:1.1rem}
.badge{padding:10px 12px;border-radius:999px;border:1px solid #e6edf7;background:#fff;box-shadow:0 8px 18px #0b3b6a12;font-weight:700}
.hero-cta,.hero-ghost{width:100%;margin-top:.6rem}
.screen{display:none}.screen.active{display:block}
.page{padding:0 16px 110px}
.box{background:var(--card);border-radius:22px;box-shadow:var(--shadow);padding:16px}
.muted{color:var(--muted)}
.input{display:flex;flex-direction:column;gap:8px}
.input input,.input textarea{width:100%;padding:14px;border-radius:16px;border:1px solid #e6edf7;outline:none;box-shadow:0 6px 12px #0b3b6a0e;font-size:16px}
.radius-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.btn-chip{border:none;border-radius:999px;padding:12px 14px;background:#eef6ff;color:#0369a1;font-weight:800;cursor:pointer}
.row{display:flex;justify-content:space-between;align-items:center;padding:14px;border-radius:16px;background:#fff;border:1px solid #eaf1fb}
.row+.row{margin-top:10px}.total{font-size:18px;font-weight:900}
.cta{position:fixed;inset-inline:0;bottom:0;background:var(--glass);backdrop-filter:blur(12px);border-top:1px solid #e6edf7}
.cta .inner{max-width:480px;margin:0 auto;display:flex;gap:10px;padding:12px 16px}
.btn{appearance:none;border:none;border-radius:14px;padding:14px 16px;font-weight:900;cursor:pointer}
.btn-black{background:#111;color:#fff}.btn-ghost{background:#eaf6ff;color:#075985}
.skeleton{position:relative;overflow:hidden;background:#eef2f7;border-radius:16px}
.skeleton::after{content:"";position:absolute;inset:0;transform:translateX(-100%);background:linear-gradient(90deg,transparent,#ffffff66,transparent);animation:shimmer 1.4s infinite}
a{color:#075985}
details>summary{cursor:pointer}
.pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef6ff;color:#075985;font-size:12px;font-weight:700}
pre.debug{white-space:pre-wrap;background:#0b1220;color:#e5eefb;padding:10px;border-radius:12px;direction:ltr;overflow:auto;font-size:12px}
.small{font-size:12px}
.good{color:#047857;font-weight:800}
.bad{color:#b91c1c;font-weight:800}
.toggle{display:flex;align-items:center;gap:8px}

/* תוספות לצ'יפסים */
.chips{ display:flex; flex-wrap:wrap; gap:8px; margin-top:8px }
.chip{
  display:flex; align-items:center; gap:8px;
  padding:8px 10px; border-radius:999px;
  background:#eef6ff; border:1px solid #e6edf7;
  color:#075985; font-size:14px;
}
.chip .close{ background:transparent; border:none; color:#075985; cursor:pointer; font-size:16px; line-height:1; }
.add-row{ display:flex; gap:10px; margin-top:10px }
.btn-secondary{
  background:#fff; color:#075985; border:1px solid #e6edf7;
  border-radius:14px; padding:12px 14px; font-weight:900; cursor:pointer;
}

/* רשימת תוצאות */
.src-badge{ display:inline-block; padding:2px 8px; border-radius:999px; background:#eef6ff; color:#075985; font-size:12px; margin-inline-start:6px }
.desc{ color:#475569; font-size:12px }
</style>
</head>
<body>
<div class="app">

<!-- Screen 1: Landing -->
<section id="s1" class="screen active">
  <div class="landing">
    <header class="landing-head">
      <div class="brand-mini"><div class="dot"></div><span>CartCompare <b>AI</b></span></div>
      <a class="how" href="javascript:void(0)" id="howLink">איך זה עובד?</a>
    </header>

    <div class="landing-center">
      <h1 class="hero-title">מצא/י את סל הקניות הזול לידך</h1>
      <p class="hero-sub">מוצא את הזול במהירות באמצעות AI</p>

      <div class="badges">
        <span class="badge">⚡ חוסך זמן</span>
        <span class="badge">💸 מחיר הכי זול</span>
        <span class="badge">AI 🤖</span>
      </div>

      <button id="startBtn" class="btn btn-black hero-cta">בואו נתחיל</button>
      <button id="gpsSoon" class="btn btn-ghost hero-ghost">שימוש ב-GPS (בקרוב)</button>
    </div>
  </div>
</section>

<!-- Screen 2: Address -->
<section id="s2" class="screen">
  <div class="page">
    <div class="box">
      <div style="font-weight:800;font-size:20px">מה הכתובת שלך?</div>
      <div class="muted" style="margin-top:6px">אפשר לכתוב עיר/רחוב. (בעתיד: GPS)</div>
      <div class="input" style="margin-top:12px">
        <label class="muted" for="address">כתובת / עיר</label>
        <input id="address" placeholder="למשל: חולון, סוקולוב 10" />
      </div>
    </div>
  </div>
</section>

<!-- Screen 3: Radius -->
<section id="s3" class="screen">
  <div class="page">
    <div class="box">
      <div style="font-weight:800;font-size:20px">רדיוס חיפוש</div>
      <div class="muted" style="margin-top:6px">בחר/י כמה ק״מ מסביב לכתובת</div>
      <div class="radius-grid" style="margin-top:12px">
        <button class="btn-chip" type="button" data-radius="2">2 ק״מ</button>
        <button class="btn-chip" type="button" data-radius="5">5 ק״מ</button>
        <button class="btn-chip" type="button" data-radius="10">10 ק״מ</button>
        <button class="btn-chip" type="button" data-radius="15">15 ק״מ</button>
      </div>
      <div class="input" style="margin-top:12px">
        <label class="muted" for="radius">או הזן/י ידנית</label>
        <input id="radius" type="number" min="1" step="0.5" placeholder="15" />
      </div>
    </div>
  </div>
</section>

<!-- Screen 4: Items (עם הוספה כצ'יפסים) -->
<section id="s4" class="screen">
  <div class="page">
    <div class="box">
      <div style="font-weight:800;font-size:20px">מה תרצה לקנות?</div>
      <div class="muted" style="margin-top:6px">הוסף מוצרים בלחיצת כפתור. אפשר בעברית או אנגלית.</div>

      <div id="chips" class="chips"></div>

      <div class="add-row">
        <input id="newItem" class="input" placeholder="למשל: קוקה קולה 1.5 ליטר" />
        <button id="addBtn" class="btn-secondary" type="button" title="הוסף לרשימה">+ הוסף</button>
      </div>

      <div class="toggle" style="margin-top:12px">
        <input type="checkbox" id="verifiedOnly" checked />
        <label for="verifiedOnly">הצג רק חנויות מאומתות (UI בלבד כרגע)</label>
      </div>
    </div>
  </div>
</section>

<!-- Screen 5: Results -->
<section id="s5" class="screen">
  <div class="page">
    <div class="box">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:800;font-size:20px">התוצאות</div>
        <span class="pill">Google Maps + Shopping (+ CHP)</span>
      </div>
      <div id="summary" class="muted" style="margin-top:6px"></div>

      <div id="results" style="margin-top:12px"></div>
      <div id="loading" class="skeleton" style="height:64px;margin-top:12px;display:none"></div>

      <div id="debugWrap" style="display:none;margin-top:12px">
        <details><summary>🔧 Debug</summary><pre id="debugJson" class="debug"></pre></details>
      </div>
    </div>
  </div>
</section>

<div class="cta">
  <div class="inner">
    <button id="back" class="btn btn-ghost" type="button">חזרה</button>
    <button id="next" class="btn btn-black" type="button">הבא</button>
  </div>
</div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const screens = ['s1','s2','s3','s4','s5'].map(id=>document.getElementById(id));
  let step = 0;
  const btnNext = document.getElementById('next');
  const btnBack = document.getElementById('back');
  const startBtn = document.getElementById('startBtn');
  const howLink = document.getElementById('howLink');
  const gpsSoon = document.getElementById('gpsSoon');

  const addressEl = document.getElementById('address');
  const radiusEl = document.getElementById('radius');
  const verifiedOnlyEl = document.getElementById('verifiedOnly');

  // items via chips
  const chipsEl = document.getElementById('chips');
  const newItemEl = document.getElementById('newItem');
  let items = ["קוקה קולה 1.5 ליטר", "מים מינרלים 1.5 ליטר", "פסטה"];

  const resultsEl = document.getElementById('results');
  const loadingEl = document.getElementById('loading');
  const summaryEl = document.getElementById('summary');
  const debugWrap = document.getElementById('debugWrap');
  const debugJson = document.getElementById('debugJson');
  const isDebug = new URLSearchParams(location.search).get('debug') === '1';

  function goto(n){
    step = Math.max(0, Math.min(4, n));
    screens.forEach((s,i)=> s.classList.toggle('active', i===step));
    btnBack.textContent = step===0 ? 'יציאה' : 'חזרה';
    btnNext.textContent = step===4 ? 'חפש עכשיו' : 'הבא';
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
  goto(0);

  startBtn?.addEventListener('click', ()=> goto(1));
  howLink?.addEventListener('click', ()=> goto(1));
  gpsSoon?.addEventListener('click', ()=> alert('שימוש ב-GPS יתווסף בקרוב 😊'));

  document.querySelectorAll('[data-radius]').forEach(b=>{
    b.addEventListener('click', ()=>{
      document.querySelectorAll('[data-radius]').forEach(x=>x.dataset.active="0");
      b.dataset.active="1";
      radiusEl.value = b.getAttribute('data-radius');
      goto(step+1);
    });
  });

  btnBack.addEventListener('click', ()=>{ if(step===0){ return; } goto(step-1); });

  // ---- chips UI ----
  function renderChips(){
    chipsEl.innerHTML = "";
    items.forEach((it,i)=>{
      const chip = document.createElement('div');
      chip.className = 'chip';
      chip.innerHTML = `<span>${esc(it)}</span><button class="close" aria-label="הסר">×</button>`;
      chip.querySelector('.close').onclick = ()=>{ items.splice(i,1); renderChips(); };
      chipsEl.appendChild(chip);
    });
  }
  renderChips();

  document.getElementById('addBtn').onclick = ()=>{
    const v = (newItemEl.value||'').trim();
    if(!v) return shake(newItemEl);
    items.push(v);
    newItemEl.value = '';
    renderChips();
  };

  btnNext.addEventListener('click', async ()=>{
    if(step===1){ if(!addressEl.value.trim()) return shake(addressEl); return goto(step+1); }
    if(step===2){ if(!radiusEl.value) return shake(radiusEl); return goto(step+1); }
    if(step===3){ if(items.length===0) return shake(newItemEl); return goto(step+1); }
    if(step<4) return goto(step+1);

    // ---- Run search against /api/plan ----
    renderSkeleton();
    debugWrap.style.display = isDebug ? 'block' : 'none';
    debugJson.textContent = '';

    const payload = {
      address: addressEl.value.trim(),
      radiusKm: Number(radiusEl.value || 15),
      items
    };

    summaryEl.textContent = `כתובת: ${payload.address} • רדיוס: ${payload.radiusKm} ק״מ • פריטים: ${items.length}`;

    try{
      const res = await fetch('/api/plan', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const data = await res.json();

      loadingEl.style.display = 'none';
      if (isDebug) debugJson.textContent = JSON.stringify(data, null, 2);

      if(!res.ok || !data.ok){
        resultsEl.innerHTML = row(`שגיאת שרת (${res.status})`, data.error || 'לא ידוע');
        console.error("API error", data);
        return;
      }
      const baskets = Array.isArray(data.baskets) ? data.baskets : [];
      if(baskets.length===0){
        resultsEl.innerHTML = row('לא נמצאו תוצאות', 'נסו לדייק מותג/נפח, להגדיל רדיוס, או מיקום סמוך');
        return;
      }
      resultsEl.innerHTML = baskets.map(renderStore).join('');

    }catch(err){
      loadingEl.style.display = 'none';
      resultsEl.innerHTML = row('שגיאת רשת', err.message || String(err));
      console.error("Network error", err);
    }
  });

  function renderStore(b){
    const total = toPrice(b.total, '₪');
    const addr = b.location?.address || '';
    const lines = Array.isArray(b.breakdown) ? b.breakdown.map(renderLine).join('') : '';

    const hdr = `
      <div class="row">
        <div>
          <div><strong>${esc(b.shop_display_name||b.chain||'')}</strong></div>
          <div class="muted small">${esc(addr)}</div>
        </div>
        <div class="total">${total}</div>
      </div>
    `;
    return hdr + `<details class="box" style="margin-top:10px"><summary>פירוט סל</summary><div style="height:8px"></div>${lines}</details>`;
  }

  function renderLine(p){
    const price = (p.price==null || Number.isNaN(p.price)) ? '—' : toPrice(p.price,'₪');
    const desc = p.description ? `<div class="desc">— ${esc(p.description)}</div>` : '';
    const sub = p.substitute ? ` <span class="pill">תחליף</span>` : '';
    const link = p.link ? ` <a href="${escAttr(p.link)}" target="_blank" rel="noopener">מקור</a>` : '';
    const srcPieces = [];
    if (p.merchant) srcPieces.push(esc(p.merchant));
    if (p.domain) srcPieces.push(esc(p.domain));
    const source = srcPieces.length ? ` <span class="src-badge">${srcPieces.join(' • ')}</span>` : '';
    const title = p.chosen_title || p.title || p.item || '';

    return `
      <div class="row">
        <div>
          <div><strong>${esc(p.item||'')}</strong>${sub}</div>
          <div class="muted small">${esc(title)}</div>
          ${desc}
          <div class="small">${link}${source}</div>
        </div>
        <div class="total">${price}</div>
      </div>
    `;
  }

  function renderSkeleton(){ resultsEl.innerHTML=''; loadingEl.style.display='block'; }
  function row(title, msg){ return `<div class="row"><div><strong>${esc(title)}</strong><div class="muted small">${esc(msg)}</div></div></div>`; }
  function shake(el){ el.style.borderColor='#ffb4b4'; el.animate([{transform:'translateX(0)'},{transform:'translateX(-4px)'},{transform:'translateX(4px)'},{transform:'translateX(0)'}],{duration:260}); setTimeout(()=>el.style.borderColor='#e6edf7',320); }
  function esc(s){return String(s??'').replace(/[&<>"'`=\/]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"}[c]))}
  function escAttr(s){return String(s??'').replace(/"/g,'&quot;')}
  function toPrice(v, currency){
    if (typeof v === "number") return v.toFixed(2)+" "+currency;
    if (typeof v === "string" && v.trim()) return v.includes("₪") ? v : (v+" "+currency);
    return "—";
  }
});
</script>
</body>
</html>
