<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<title>השוואת סל קניות AI</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

<style>
/* ===== THEME: Dark AI ===== */
:root{
  --ink:#e2e8f0; --muted:#94a3b8; --brand:#3b82f6; --accent:#22d3ee;
  --bg: radial-gradient(120% 100% at 50% -10%, #0f172a 0%, #020617 60%);
  --card: rgba(255,255,255,0.06); --glass: rgba(2,6,23,.55);
  --line: rgba(255,255,255,.12); --shadow: 0 14px 34px rgba(0,0,0,.35);
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
a{color:#9ecbff;text-decoration:none}
.app{max-width:520px;margin:0 auto;min-height:100dvh;display:flex;flex-direction:column;overflow:hidden}

/* Header + Avatar */
.header{
  position:relative; padding:18px 16px 0; display:flex; align-items:center; justify-content:space-between; gap:10px;
}
.header-left{display:flex; align-items:center; gap:10px}
.brand-mini{display:flex; align-items:center; gap:10px; font-weight:900}
.brand-mini .dot{width:14px;height:14px;border-radius:50%;background:linear-gradient(135deg,#3b82f6,#22d3ee); box-shadow:0 6px 12px rgba(59,130,246,.5)}
/* Back arrow shown ליד CartCompare */
#backTopInline{
  display:none; /* hidden on step 0 */
  width:40px;height:40px;display:grid;place-items:center;
  border-radius:999px;border:1px solid var(--line);background:var(--card);cursor:pointer;
}
#backTopInline svg{width:20px;height:20px;fill:#cbd5e1}
.ai-avatar{
  display:flex; align-items:center; gap:12px;
  background:var(--card); border:1px solid var(--line); border-radius:16px; padding:10px 12px;
}
.ai-avatar img{ width:42px; height:42px; border-radius:12px; object-fit:cover; background:#0b1220 }
.ai-avatar .t1{ font-weight:800; }
.ai-avatar .t2{ color:var(--muted); font-size:12px }

/* Screens */
.screen{display:none}.screen.active{display:block}
.page{padding:0 16px 120px}
.box{background:var(--card);border-radius:22px;box-shadow:var(--shadow);padding:16px;border:1px solid var(--line);backdrop-filter:blur(14px)}
.muted{color:var(--muted)}
.input{display:flex;flex-direction:column;gap:8px}
.input input,.input textarea{width:100%;padding:14px;border-radius:16px;border:1px solid var(--line);outline:none;background:rgba(255,255,255,.04);color:var(--ink)}
.input input:focus{border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,.25)}

/* Landing */
.landing{position:relative;min-height:100dvh;padding:12px 16px 140px;display:flex;flex-direction:column;justify-content:flex-start}
.landing-center{text-align:center; margin-top:20px}
.hero-illustration{
  width:170px; height:170px; margin:18px auto 10px; border-radius:24px; background:radial-gradient(circle at 30% 30%, rgba(96,165,250,.8), transparent 70%);
  display:grid; place-items:center; box-shadow:0 0 34px rgba(59,130,246,.35);
}
.hero-title{font-size:clamp(22px,5.2vw,30px);line-height:1.15;margin:6px 0;
  background:linear-gradient(90deg,#3b82f6,#22d3ee); -webkit-background-clip:text; -webkit-text-fill-color:transparent}
.hero-sub{color:var(--muted); margin:.5rem 0 1.1rem}
.badges{display:flex; gap:8px; justify-content:center; flex-wrap:wrap}
.badge{padding:10px 12px;border-radius:999px;border:1px solid var(--line);background:var(--card);box-shadow:var(--shadow);font-weight:700}

/* Chips + Dropdown */
.chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.chip{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid var(--line);color:#cfe2ff;font-size:14px}
.chip .close{background:transparent;border:none;color:#9fb6ff;cursor:pointer;font-size:16px;line-height:1}
.add-row{display:flex;gap:10px;margin-top:10px;position:relative}
.btn-secondary{background:transparent;color:#dbeafe;border:1px solid var(--line);border-radius:14px;padding:12px 14px;font-weight:900;cursor:pointer}
.dropdown{position:absolute;inset-inline-start:0;top:44px;right:0;left:0;background:rgba(2,6,23,.95);border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow);z-index:10;max-height:280px;overflow:auto}
.opt{padding:10px 12px;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
.opt:hover,.opt.active{background:rgba(59,130,246,.12)}
.opt .left{display:flex;flex-direction:column}
.opt .label{font-weight:700}
.opt .meta{color:#9fb0c8;font-size:12px}

/* Radius */
.radius-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.btn-chip{border:1px solid var(--line);border-radius:999px;padding:12px 14px;background:rgba(59,130,246,.08);color:#cfe2ff;font-weight:800;cursor:pointer}
.btn-chip:hover{border-color:#3b82f6}

/* Results */
.row{display:flex;justify-content:space-between;align-items:center;padding:14px;border-radius:16px;background:rgba(255,255,255,.04);border:1px solid var(--line)}
.row+.row{margin-top:10px}.total{font-size:18px;font-weight:900}
.small{font-size:12px}.desc{color:#b6c3d8;font-size:12px}
.pill{display:inline-block;padding:4px 8px;border-radius:999px;background:rgba(59,130,246,.12);color:#bfe0ff;font-size:12px;font-weight:700}
.conf{font-size:12px;color:#22c55e;font-weight:800}
.unit{font-size:12px;color:#93c5fd;font-weight:800}
.map{width:100%;height:260px;border-radius:14px;border:1px solid var(--line);margin-top:10px;overflow:hidden}

/* Primary Button (also for “בואו נתחיל”) */
.btn{
  appearance:none;border:none;border-radius:18px;padding:16px 24px;font-weight:900;cursor:pointer;
  box-shadow:0 14px 34px rgba(59,130,246,.35), inset 0 0 0 1px #ffffff22; letter-spacing:.3px; font-size:18px;
}
.btn-primary{
  background:conic-gradient(from 0deg at 50% 50%, #3b82f6, #22d3ee, #3b82f6);
  color:#06151d; display:inline-flex; align-items:center; justify-content:center; gap:10px;
}
.btn-primary .spark{
  width:12px; height:12px; border-radius:999px; background:radial-gradient(circle at 50% 50%, #fff, #bfe0ff 70%, transparent);
  box-shadow:0 0 18px #bfe0ff; animation:pulse 1.6s ease-in-out infinite;
}
@keyframes pulse{0%{transform:scale(.8);opacity:.8}50%{transform:scale(1);opacity:1}100%{transform:scale(.8);opacity:.8}}

/* AI Loader */
#loading{display:none;margin-top:12px;text-align:center}
#loading .msg{color:#bcd3ff;margin-top:6px}
.ai-loader{position:relative;width:120px;height:120px;margin:26px auto}
.ai-loader::before,.ai-loader::after{content:"";position:absolute;border-radius:50%;inset:0}
.ai-loader::before{
  background: radial-gradient(circle at 30% 30%, rgba(96,165,250,.75), transparent 70%);
  animation: ai-ring 1.6s cubic-bezier(.21,.61,.36,1) infinite; box-shadow:0 0 32px rgba(59,130,246,.55)
}
.ai-loader::after{
  width:24px;height:24px;margin:auto; inset:auto 0 0 0;
  background: radial-gradient(circle at 50% 50%, #3b82f6 0%, #22d3ee 90%);
  animation: ai-dot 1.6s ease-in-out infinite -.4s; box-shadow:0 0 24px rgba(34,211,238,.7)
}
@keyframes ai-ring{0%{transform:scale(.35);opacity:.95}80%,100%{opacity:0}}
@keyframes ai-dot{0%{transform:scale(.8)}50%{transform:scale(1)}100%{transform:scale(.8)}}

/* מרכז כפתור “המשך” — מוסתר בעמוד הראשון */
.cta{
  position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
  pointer-events:none;
}
.cta .inner{ pointer-events:auto; }
body[data-step="0"] .cta{ display:none; } /* לא בעמוד הראשון */

</style>
</head>

<body data-step="0">
<div class="app">
  <!-- Header with brand + back arrow ליד CartCompare -->
  <div class="header">
    <div class="header-left">
      <div class="brand-mini"><div class="dot"></div><span>CartCompare <b>AI</b></span></div>
      <button id="backTopInline" title="חזרה" aria-label="חזרה שלב">
        <!-- arrow right -->
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M8.59 16.59 13.17 12 8.59 7.41 10 6l6 6-6 6z"/></svg>
      </button>
    </div>
    <div class="ai-avatar">
      <img src="/ai-avatar.png" alt="AI Avatar" onerror="this.outerHTML=getBotSVG()">
      <div>
        <div class="t1">Assistant</div>
        <div class="t2">Always-on smart helper</div>
      </div>
    </div>
  </div>

  <!-- Screen 1 -->
  <section id="s1" class="screen active">
    <div class="landing">
      <div class="landing-center" id="landingSwipe">
        <div class="hero-illustration" aria-hidden="true">
          <svg width="120" height="120" viewBox="0 0 120 120">
            <defs><radialGradient id="g1" cx="50%" cy="50%" r="60%"><stop offset="0%" stop-color="#3b82f6"/><stop offset="100%" stop-color="#22d3ee"/></radialGradient></defs>
            <circle cx="60" cy="60" r="40" fill="url(#g1)" opacity="0.85">
              <animate attributeName="r" values="36;44;36" dur="3s" repeatCount="indefinite"/>
            </circle>
          </svg>
        </div>
        <h1 class="hero-title">מצא/י את סל הקניות הזול לידך</h1>
        <p class="hero-sub">מוצא את הזול במהירות באמצעות AI</p>
        <div class="badges">
          <span class="badge">⚡ חוסך זמן</span>
          <span class="badge">💸 מחיר הכי זול</span>
          <span class="badge">AI 🤖</span>
        </div>

        <!-- "בואו נתחיל" בצבע של המשך, מעל ה-GPS -->
        <button id="startBtn" class="btn btn-primary" style="margin-top:12px">
          <span class="spark" aria-hidden="true"></span>
          בואו נתחיל
        </button>
        <button id="gpsBtn" class="btn btn-secondary" style="margin-top:10px">שימוש ב-GPS</button>
        <div class="muted" style="margin-top:8px;font-size:12px">או החלק/י מימין לשמאל כדי להתחיל</div>
      </div>
    </div>
  </section>

  <!-- Screen 2: Address -->
  <section id="s2" class="screen">
    <div class="page">
      <div class="box">
        <div style="font-weight:800;font-size:20px">מה הכתובת שלך?</div>
        <div class="muted" style="margin-top:6px">אפשר עיר/רחוב או GPS מהמסך הקודם</div>
        <div class="input" style="margin-top:12px">
          <label class="muted" for="address">כתובת / עיר</label>
          <input id="address" placeholder="למשל: חולון, סוקולוב 10" />
        </div>
      </div>
    </div>
  </section>

  <!-- Screen 3: Radius -->
  <section id="s3" class="screen">
    <div class="page">
      <div class="box">
        <div style="font-weight:800;font-size:20px">רדיוס חיפוש</div>
        <div class="muted" style="margin-top:6px">בחר/י כמה ק״מ מסביב לכתובת/ל-GPS</div>
        <div class="radius-grid" style="margin-top:12px">
          <button class="btn-chip" type="button" data-radius="2">2 ק״מ</button>
          <button class="btn-chip" type="button" data-radius="5">5 ק״מ</button>
          <button class="btn-chip" type="button" data-radius="10">10 ק״מ</button>
          <button class="btn-chip" type="button" data-radius="15">15 ק״מ</button>
        </div>
        <div class="input" style="margin-top:12px">
          <label class="muted" for="radius">או הזן/י ידנית</label>
          <input id="radius" type="number" min="1" step="0.5" placeholder="15" />
        </div>
      </div>
    </div>
  </section>

  <!-- Screen 4: Items + Autocomplete -->
  <section id="s4" class="screen">
    <div class="page">
      <div class="box">
        <div style="font-weight:800;font-size:20px">מה תרצה לקנות?</div>
        <div class="muted" style="margin-top:6px">הוסף מוצרים בלחיצה. “קו 1.5 ל” → קוקה קולה 1.5 ל׳, “פסטה 500” → פסטה 500 גרם…</div>
        <div id="chips" class="chips"></div>
        <div class="add-row">
          <input id="newItem" class="input" placeholder="למשל: קו 1.5 ל / פחית 330 / פסטה 500..." autocomplete="off" />
          <button id="addBtn" class="btn-secondary" type="button" title="הוסף לרשימה">+ הוסף</button>
          <div id="dropdown" class="dropdown" style="display:none"></div>
        </div>
        <div class="toggle" style="margin-top:12px">
          <input type="checkbox" id="verifiedOnly" checked />
          <label for="verifiedOnly">הצג רק חנויות מאומתות (ויזואלי)</label>
        </div>
      </div>
    </div>
  </section>

  <!-- Screen 5: Results -->
  <section id="s5" class="screen">
    <div class="page">
      <div class="box">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:800;font-size:20px">התוצאות</div>
          <span class="pill">Maps + Shopping + CHP + Web</span>
        </div>
        <div id="summary" class="muted" style="margin-top:6px"></div>
        <div id="results" style="margin-top:12px"></div>

        <!-- AI Loader -->
        <div id="loading">
          <div class="ai-loader"></div>
          <div class="msg">AI מנתח את סל הקניות שלך...</div>
        </div>

        <div id="debugWrap" style="display:none;margin-top:12px">
          <details><summary>🔧 Debug</summary><pre id="debugJson" class="debug"></pre></details>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- כפתור “המשך” ממורכז — לא מוצג בעמוד הראשון -->
<div class="cta" id="cta">
  <div class="inner">
    <button id="next" class="btn btn-primary" type="button">
      <span class="spark" aria-hidden="true"></span>
      המשך
    </button>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
/* Fallback SVG לאווטאר */
function getBotSVG(){
  return '<svg width="42" height="42" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" style="border-radius:12px;background:#0b1220"><defs><linearGradient id="lg" x1="0" x2="1"><stop offset="0" stop-color="#3b82f6"/><stop offset="1" stop-color="#22d3ee"/></linearGradient></defs><g fill="url(#lg)"><rect x="14" y="18" rx="10" ry="10" width="36" height="26"/><circle cx="24" cy="30" r="3" fill="#fff"/><circle cx="40" cy="30" r="3" fill="#fff"/><rect x="22" y="40" width="20" height="4" rx="2"/></g></svg>';
}

document.addEventListener('DOMContentLoaded', () => {
  const screens = ['s1','s2','s3','s4','s5'].map(id=>document.getElementById(id));
  let step = 0;
  const bodyEl = document.body;
  const btnNext = document.getElementById('next');
  const cta = document.getElementById('cta');
  const startBtn = document.getElementById('startBtn');
  const gpsBtn = document.getElementById('gpsBtn');
  const backTopInline = document.getElementById('backTopInline');
  const landingSwipe = document.getElementById('landingSwipe');

  const addressEl = document.getElementById('address');
  const radiusEl = document.getElementById('radius');
  const verifiedOnlyEl = document.getElementById('verifiedOnly');

  const chipsEl = document.getElementById('chips');
  const newItemEl = document.getElementById('newItem');
  const dropdown = document.getElementById('dropdown');
  let items = ["קוקה קולה 1.5 ליטר", "מים מינרליים 1.5 ליטר", "פסטה 500 גרם"];

  const resultsEl = document.getElementById('results');
  const loadingEl = document.getElementById('loading');
  const summaryEl = document.getElementById('summary');
  const debugWrap = document.getElementById('debugWrap');
  const debugJson = document.getElementById('debugJson');
  const isDebug = new URLSearchParams(location.search).get('debug') === '1';

  function setStep(n){
    step = Math.max(0, Math.min(4, n));
    bodyEl.setAttribute('data-step', String(step));
    screens.forEach((s,i)=> s.classList.toggle('active', i===step));
    // חץ ליד CartCompare רק אחרי צעד ראשון
    backTopInline.style.display = step > 0 ? 'grid' : 'none';
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
  setStep(0);

  // Start actions
  startBtn?.addEventListener('click', ()=> setStep(1));
  backTopInline?.addEventListener('click', ()=> { if(step>0) setStep(step-1); });

  // Swipe (מימין לשמאל כדי להתחיל) על מסך הנחיתה
  let touchXStart = null, touchYStart = null;
  landingSwipe?.addEventListener('touchstart', (e)=>{
    const t = e.touches[0]; touchXStart = t.clientX; touchYStart = t.clientY;
  }, {passive:true});
  landingSwipe?.addEventListener('touchend', (e)=>{
    if (touchXStart===null) return;
    const t = e.changedTouches[0]; const dx = t.clientX - touchXStart; const dy = Math.abs((t.clientY - (touchYStart??t.clientY)));
    // החלקה משמעותית לרוחב, כמעט ללא תזוזה אנכית, לכיוון שמאל (RTL: מימין לשמאל = dx < -50)
    if (dx < -50 && dy < 40) setStep(1);
    touchXStart = touchYStart = null;
  });

  // GPS
  let gps = null;
  gpsBtn?.addEventListener('click', ()=>{
    if (!navigator.geolocation) return alert('הדפדפן לא תומך ב-GPS');
    navigator.geolocation.getCurrentPosition(
      (pos)=>{ gps = { lat: pos.coords.latitude, lng: pos.coords.longitude }; alert('מיקום זוהה ✅'); setStep(2); },
      (err)=> alert('שגיאת GPS: ' + (err.message||err.code)),
      { enableHighAccuracy: true, timeout: 10000, maximumAge: 5000 }
    );
  });

  // רדיוס מהיר
  document.querySelectorAll('[data-radius]').forEach(b=>{
    b.addEventListener('click', ()=>{
      document.querySelectorAll('[data-radius]').forEach(x=>x.dataset.active="0");
      b.dataset.active="1";
      radiusEl.value = b.getAttribute('data-radius');
      setStep(step+1);
    });
  });

  // Chips UI
  function renderChips(){
    chipsEl.innerHTML = "";
    items.forEach((it,i)=>{
      const chip = document.createElement('div');
      chip.className = 'chip';
      chip.innerHTML = `<span>${esc(it)}</span><button class="close" aria-label="הסר">×</button>`;
      chip.querySelector('.close').onclick = ()=>{ items.splice(i,1); renderChips(); };
      chipsEl.appendChild(chip);
    });
  }
  renderChips();

  document.getElementById('addBtn').onclick = ()=>{
    const v = (newItemEl.value||'').trim();
    if(!v) return shake(newItemEl);
    items.push(v);
    newItemEl.value = '';
    hideDropdown();
    renderChips();
  };

  // Autocomplete
  let activeIdx = -1;
  newItemEl.addEventListener('input', async ()=>{
    const q = newItemEl.value.trim();
    if (!q) return hideDropdown();
    try{
      const res = await fetch(`/api/suggest?q=${encodeURIComponent(q)}&limit=12`);
      const data = await res.json();
      const list = Array.isArray(data.suggestions) ? data.suggestions : [];
      if (!list.length) return hideDropdown();
      dropdown.innerHTML = list.map((s,i)=>(
        `<div class="opt" data-i="${i}">
          <div class="left">
            <div class="label">${esc(s.label)}</div>
            <div class="meta">${esc(s.canonical)} ${s.default_size? '• '+esc(s.default_size):''}${(s.tags||[]).includes('LocalDB')?' • מאגר מקומי':''}</div>
          </div>
          <div>${s.brand? esc(s.brand):''}</div>
        </div>`
      )).join('');
      dropdown.style.display = 'block';
      activeIdx = -1;

      dropdown.querySelectorAll('.opt').forEach(opt=>{
        opt.addEventListener('click', ()=>{
          const i = Number(opt.getAttribute('data-i'));
          const picked = list[i];
          if (!picked) return;
          items.push(picked.label);
          newItemEl.value = '';
          hideDropdown();
          renderChips();
        });
      });
    }catch{ hideDropdown(); }
  });
  newItemEl.addEventListener('keydown', (e)=>{
    if (dropdown.style.display !== 'block') return;
    const opts = Array.from(dropdown.querySelectorAll('.opt'));
    if (e.key === 'ArrowDown'){ e.preventDefault(); activeIdx = Math.min(opts.length-1, activeIdx+1); setActive(opts); }
    else if (e.key === 'ArrowUp'){ e.preventDefault(); activeIdx = Math.max(0, activeIdx-1); setActive(opts); }
    else if (e.key === 'Enter'){ if (activeIdx >= 0){ e.preventDefault(); opts[activeIdx].click(); } }
    else if (e.key === 'Escape'){ hideDropdown(); }
  });
  function setActive(opts){ opts.forEach((el,i)=> el.classList.toggle('active', i===activeIdx)); }
  function hideDropdown(){ dropdown.style.display='none'; dropdown.innerHTML=''; activeIdx=-1; }

  // כפתור המשך — אשף + /api/plan
  btnNext.addEventListener('click', async ()=>{
    if(step===1){ if(!gps && !addressEl.value.trim()) return shake(addressEl); return setStep(step+1); }
    if(step===2){ if(!radiusEl.value) return shake(radiusEl); return setStep(step+1); }
    if(step===3){ if(items.length===0) return shake(newItemEl); return setStep(step+1); }
    if(step<4) return setStep(step+1);

    renderLoading(true);
    debugWrap.style.display = isDebug ? 'block' : 'none';
    debugJson.textContent = '';

    const payload = gps
      ? { lat: gps.lat, lng: gps.lng, radiusKm: Number(radiusEl.value || 15), items, include_debug: isDebug }
      : { address: addressEl.value.trim(), radiusKm: Number(radiusEl.value || 15), items, include_debug: isDebug };

    summaryEl.textContent = `${gps ? 'GPS' : 'כתובת: ' + (payload.address||'—')} • רדיוס: ${payload.radiusKm || payload.radius_km || ''} ק״מ • פריטים: ${items.length}`;

    try{
      const res = await fetch('/api/plan', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      const ct = res.headers.get('content-type') || '';
      const raw = await res.text();
      let data = null;
      if (ct.includes('application/json')) { try { data = JSON.parse(raw); } catch {} }

      renderLoading(false);
      if(!res.ok || !data || data.ok === false){
        resultsEl.innerHTML = row(`שגיאת שרת (${res.status})`, data?.error || raw.slice(0, 400));
        return;
      }
      const baskets = Array.isArray(data.baskets) ? data.baskets : [];
      if(baskets.length===0){ resultsEl.innerHTML = row('לא נמצאו תוצאות', 'נסו להרחיב/לדייק'); return; }
      resultsEl.innerHTML = baskets.map((b,i)=>renderStore(b,i)).join('');
      wireStoreMaps(baskets);
    }catch(err){
      renderLoading(false);
      resultsEl.innerHTML = row('שגיאת רשת', err.message || String(err));
    }
  });

  function renderStore(b, idx){
    const total = toPrice(b.total, '₪');
    const addr = b.location?.address || '';
    const mo = (typeof b.match_overall === 'number') ? `${Math.round(b.match_overall*100)}%` : '—';
    const cov = (typeof b.coverage === 'number') ? `${Math.round(b.coverage*100)}%` : '—';
    const dist = (typeof b.distance_km === 'number') ? ` • מרחק ${b.distance_km} ק״מ` : '';

    const hdr = `
      <div class="row">
        <div>
          <div><strong>${esc(b.shop_display_name||b.chain||'')}</strong></div>
          <div class="muted small">${esc(addr)} • דיוק כללי ${mo} • כיסוי ${cov}${dist}</div>
        </div>
        <div class="total">${total}</div>
      </div>
    `;
    return hdr + `
      <details class="box" style="margin-top:10px" data-idx="${idx}">
        <summary>פירוט סל + מפה</summary>
        <div style="height:8px"></div>
        <div class="map" id="map-${idx}" data-lat="${b.location?.lat??''}" data-lng="${b.location?.lng??''}"></div>
        <div style="height:8px"></div>
        ${Array.isArray(b.breakdown) ? b.breakdown.map(renderLine).join('') : ''}
      </details>`;
  }

  function renderLine(p){
    const price = (p.price==null || Number.isNaN(p.price)) ? '—' : toPrice(p.price,'₪');
    const desc = p.description ? `<div class="desc">— ${esc(p.description)}</div>` : '';
    const sub = p.substitute ? ` <span class="pill">תחליף</span>` : '';
    const link = p.source_url ? ` <a href="${escAttr(p.source_url)}" target="_blank" rel="noopener">מקור</a>` : (p.link ? ` <a href="${escAttr(p.link)}" target="_blank" rel="noopener">מקור</a>` : '');
    const srcPieces = [];
    if (p.merchant) srcPieces.push(esc(p.merchant));
    if (p.domain) srcPieces.push(esc(p.domain));
    const source = srcPieces.length ? ` <span class="pill">${srcPieces.join(' • ')}</span>` : '';
    const brand = p.product_brand || p.schema_brand;
    const brandBadge = brand ? ` <span class="pill">${esc(brand)}</span>` : '';
    const unit = (typeof p.unit_per_liter === 'number') ? `<span class="unit">₪/ל׳ ${p.unit_per_liter.toFixed(2)}</span>` :
                 (typeof p.unit_per_kg === 'number') ? `<span class="unit">₪/ק״ג ${p.unit_per_kg.toFixed(2)}</span>` : '';
    const conf = (typeof p.confidence_pct === 'number') ? `<span class="conf">${p.confidence_pct}% אמינות</span>` : '';
    const title = p.product_name || p.chosen_title || p.title || p.item || '';
    const size = p.size_text ? ` <span class="pill">${esc(p.size_text)}</span>` : '';

    return `
      <div class="row">
        <div>
          <div><strong>${esc(p.item||'')}</strong>${sub}${brandBadge}${size}</div>
          <div class="muted small">${esc(title)}</div>
          ${desc}
          <div class="small">${link}${source} ${unit} ${conf}</div>
        </div>
        <div class="total">${price}</div>
      </div>
    `;
  }

  function wireStoreMaps(){
    document.querySelectorAll('details[data-idx]').forEach((det)=>{
      det.addEventListener('toggle', ()=>{
        if (!det.open) return;
        const idx = det.getAttribute('data-idx');
        const mapDiv = document.getElementById('map-'+idx);
        if (!mapDiv || mapDiv.dataset.inited==="1") return;

        const lat = Number(mapDiv.getAttribute('data-lat'));
        const lng = Number(mapDiv.getAttribute('data-lng'));
        if (!lat || !lng) return;

        const m = L.map(mapDiv).setView([lat,lng], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(m);
        L.marker([lat,lng]).addTo(m);
        mapDiv.dataset.inited = "1";
        setTimeout(()=>m.invalidateSize(), 50);
      });
    });
  }

  function renderLoading(on){ loadingEl.style.display = on ? 'block' : 'none'; }
  function row(title, msg){ return `<div class="row"><div><strong>${esc(title)}</strong><div class="muted small">${esc(msg)}</div></div></div>`; }
  function shake(el){ el.style.borderColor='#3b82f6'; el.animate([{transform:'translateX(0)'},{transform:'translateX(-4px)'},{transform:'translateX(4px)'},{transform:'translateX(0)'}],{duration:260}); setTimeout(()=>el.style.borderColor='var(--line)',320); }
  function esc(s){return String(s??'').replace(/[&<>"'`=\/]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"}[c]))}
  function escAttr(s){return String(s??'').replace(/"/g,'&quot;')}
  function toPrice(v, currency){
    if (typeof v === "number") return v.toFixed(2)+" "+currency;
    if (typeof v === "string" && v.trim()) return v.includes("₪") ? v : (v+" "+currency);
    return "—";
  }
});
</script>
</body>
</html>
